format_version: "5"
default_step_lib_source: https://github.com/bitrise-io/bitrise-steplib.git
project_type: android
trigger_map:
- push_branch: "release"
  workflow: release
- push_branch: "*"
  workflow: debug
- pull_request_target_branch: "*"
  workflow: debug

workflows:

  _setup:
    steps:
    - activate-ssh-key@3.1.1:
        run_if: '{{getenv "SSH_RSA_PRIVATE_KEY" | ne ""}}'
    - git-clone: {}

  _debug_apk:
    steps:
    - script@1.1.5:
        title: Set Environment
        inputs:
        - content: |-
            envman add --key ENVIRONMENT --value "DEBUG"
    - script@1.1.5:
        title: Build APK
        inputs:
        - content: |-
            #!/bin/bash

            ./gradlew assembleDebug
    - script@1.1.5:
        title: cp apk
        inputs:
        - content: |-
            #!/bin/bash
            cp $BITRISE_SIGNED_APK_PATH $BITRISE_DEPLOY_DIR/app.apk

  _release_apk:
    steps:
    - script@1.1.5:
        title: Set Environment
        inputs:
        - content: |-
            envman add --key ENVIRONMENT --value "RELEASE"
    - script@1.1.5:
        title: Build APK
        inputs:
        - content: |-
            #!/bin/bash

            ./gradlew assembleRelease
    - sign-apk@1.1.1:
        inputs:
        - apk_path: "/bitrise/src/android/app/build/outputs/apk/app-release-unsigned.apk"
    - script@1.1.5:
        title: cp apk
        inputs:
        - content: |-
            #!/bin/bash
            cp $BITRISE_SIGNED_APK_PATH $BITRISE_DEPLOY_DIR/app.apk

  release:
    before_run:
    - _setup
    - _release_apk

  debug:
    before_run:
    - _setup
    - _debug_apk